---
title: 블로그 업데이트
author: haruair
type: post
date: 2018-09-27T08:14:00-07:00
lang: ko
slug: blog-updates
categories:
  - 나의 이야기
tags:
  - blog
  - housekeeping
  - gatsby
draft: true
---

✨ wordpress에서 gatsby로 전환했다! ✨

- react and graphql, 궁금했다
- wordpress-to-hugo-exporter 플러그인으로 초기 데이터 생성
  - 기존 블로그의 url도 history로 추가
  - headline도 추가
- feed.xml and /ko/feed.xml 주소가 달라지는 점은 아쉽지만
- typography.js 스타일에 한글 서체 추가
- `gatsby-plugin-sitemap` 구글용
- `gatsby-plugin-catch-links` 마크다운 내에 있는 내부 링크도 gatsby에서 제공하는 `Link`로 감아주는 플러그인
- `gatsby-plugin-offline`, `gatsby-plugin-manifest` pwa 기능들
- `prismjs` 문법 강조
- social card (og and twitter) 플러그인이 있을 것 같은데 일단 helmet으로
- rel="canonical" -> 301 redirect 언젠가
  - redirect.json 을 생성하도록 했고 전 블로그에서 이 데이터 사용하기로
- 디버그하는데 시간이 걸림
  - cloudflare cache도 있고 github pages도 반영이 느림.

- 404 페이지에서 링크가 제대로 동작하지 않는 문제
  - gatsby의 문제였음. 이슈가 열려 있는 상태라 follow.

원래 github pages + cloudflare 사용하고 있었는데 netlify로 옮겼음.

```php
<?php
if (php_sapi_name() !== 'cli') exit;
require_once(__DIR__ .'/wp-load.php');

$filename = './redirect.json';
$key = '_yoast_wpseo_canonical';

$data = json_decode(file_get_contents($filename));

foreach($data as $r) {
  $u = explode('/', $r->from);
  $id = array_pop($u);
  if (!is_numeric($id)) continue;

  $canonical = get_post_meta($id, $key);
  if ($canonical !== null) continue;

  update_post_meta($id, $key, $r->to);
  echo "SET {$id} {$r->to}". PHP_EOL;
}
```

- `gatsby-plugin-google-analytics` 설정
- google searchconsole에 등록하고 sitemap.xml 추가로 크롤링 시작
- WP AMP의 canonical도 갱신해줌

```php
<?php
function haruair_amp_canonical($data, $post) {
  $data['canonical_url'] = get_post_meta($post->ID, 'ㅇ', true);
  return $data;
}

add_filter('amp_post_template_data', 'haruair_amp_canonical', 100, 2);
```
